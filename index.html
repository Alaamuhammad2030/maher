<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Accounting Lite</title>
  <style>
    :root{
      --bg:#0b1220;--panel:#111a2e;--panel2:#0f1730;--text:#e8eefc;--muted:#a9b4d0;
      --line:#223055;--brand:#4f7cff;--danger:#ff4f6d;--ok:#2dd4bf;--warn:#fbbf24
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    a{color:inherit;text-decoration:none}
    .wrap{max-width:1180px;margin:0 auto;padding:16px}
    .top{
      position:sticky;top:0;z-index:10;
      background:rgba(11,18,32,.9);backdrop-filter:blur(8px);
      border-bottom:1px solid var(--line);
      margin:-16px -16px 14px; padding:12px 16px;
      display:flex;gap:10px;align-items:center;justify-content:space-between
    }
    .brand{font-weight:900;letter-spacing:.4px}
    .pill{border:1px solid var(--line);border-radius:999px;padding:6px 10px;color:var(--muted);font-size:12px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .sp{flex:1}
    .btn{
      padding:10px 12px;border-radius:12px;border:1px solid var(--line);
      background:transparent;color:var(--text);cursor:pointer
    }
    .btn.primary{background:var(--brand);border-color:transparent;color:#06102a;font-weight:900}
    .btn.danger{border-color:rgba(255,79,109,.6);color:var(--danger)}
    .btn.small{padding:8px 10px;border-radius:10px;font-size:13px}
    .btn.ghost{background:transparent}
    .input, select, textarea{
      width:100%;padding:10px;border-radius:12px;border:1px solid var(--line);
      background:#0c1428;color:var(--text);outline:none
    }
    .card{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:14px}
    .hidden{display:none}
    .grid{display:grid;grid-template-columns:260px 1fr;gap:14px}
    .side{
      background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:12px;
      position:sticky;top:78px;height:calc(100vh - 108px);overflow:auto
    }
    .side a{
      display:flex;align-items:center;justify-content:space-between;
      padding:10px 10px;border-radius:12px;color:var(--muted);margin-bottom:8px
    }
    .side a.active{background:var(--panel2);color:var(--text);border:1px solid var(--line)}
    .content{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:16px;min-height:70vh}
    .h1{font-size:18px;margin:0 0 12px}
    .note{color:var(--muted);font-size:13px}
    .cards{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px;margin-bottom:14px}
    .kpi{background:var(--panel2);border:1px solid var(--line);border-radius:16px;padding:12px}
    .kpi .k{font-size:12px;color:var(--muted)}
    .kpi .v{font-size:20px;font-weight:900;margin-top:6px}
    hr{border:0;border-top:1px solid var(--line);margin:14px 0}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 8px;border-bottom:1px solid var(--line);text-align:left}
    th{color:var(--muted);font-weight:800;font-size:13px}
    td{font-size:14px;vertical-align:top}
    .right{text-align:right}
    .form{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px;align-items:end;margin:10px 0 14px}
    .span2{grid-column:span 2}
    .span3{grid-column:span 3}
    .span4{grid-column:span 4}
    .badge{display:inline-flex;align-items:center;padding:4px 8px;border-radius:999px;border:1px solid var(--line);font-size:12px;color:var(--muted)}
    .linebox{background:var(--panel2);border:1px solid var(--line);border-radius:14px;padding:12px}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:980px){
      .grid{grid-template-columns:1fr}
      .side{position:relative;top:auto;height:auto}
      .cards{grid-template-columns:repeat(2,minmax(0,1fr))}
      .form{grid-template-columns:repeat(2,minmax(0,1fr))}
      .two{grid-template-columns:1fr}
    }
    @media print{
      body{background:#fff;color:#000}
      .top,.side,.no-print{display:none !important}
      .content{border:none;background:#fff}
      .card,.kpi,.linebox{border:none}
      table,th,td{border-bottom:1px solid #ddd}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="row">
        <div class="brand">Accounting Lite</div>
        <div class="pill">GitHub Pages + Firebase</div>
        <div class="pill" id="companyPill">Company: -</div>
      </div>
      <div class="row">
        <div class="pill" id="userPill">Not signed in</div>
        <button class="btn danger small hidden" id="btnLogout">Logout</button>
      </div>
    </div>

    <!-- LOGIN -->
    <div class="card" id="loginView">
      <h3 class="h1">Login</h3>
      <div class="note">Email/Password (Firebase Auth)</div>

      <div class="form" style="grid-template-columns:1fr 1fr">
        <div>
          <div class="note">Email</div>
          <input class="input" id="email" type="email" placeholder="name@domain.com" />
        </div>
        <div>
          <div class="note">Password</div>
          <input class="input" id="password" type="password" placeholder="••••••••" />
        </div>
        <div class="span2">
          <button class="btn primary" id="btnLogin">Sign in</button>
          <span class="note" id="loginMsg" style="margin-left:10px"></span>
        </div>
      </div>
    </div>

    <!-- APP -->
    <div class="grid hidden" id="appView">
      <aside class="side no-print">
        <a href="#" data-nav="dashboard" class="active"><span>Dashboard</span><span class="badge" id="dbBadge">DB</span></a>
        <a href="#" data-nav="customers"><span>Customers</span><span class="badge">CRUD</span></a>
        <a href="#" data-nav="suppliers"><span>Suppliers</span><span class="badge">CRUD</span></a>
        <a href="#" data-nav="items"><span>Items</span><span class="badge">CRUD</span></a>
        <a href="#" data-nav="expenses"><span>Expenses</span><span class="badge">CRUD</span></a>
        <a href="#" data-nav="invoices"><span>Invoices</span><span class="badge">Sales</span></a>
        <a href="#" data-nav="reports"><span>Reports</span><span class="badge">Range</span></a>
        <a href="#" data-nav="settings"><span>Settings</span><span class="badge">Tax</span></a>
        <hr />
        <div class="note">Collections: customers, suppliers, items, expenses, invoices, settings, counters</div>
      </aside>

      <main class="content">
        <!-- DASHBOARD -->
        <div id="view-dashboard">
          <h1 class="h1">Dashboard</h1>
          <div class="cards">
            <div class="kpi"><div class="k">Sales (range)</div><div class="v" id="kpiSales">0.00</div></div>
            <div class="kpi"><div class="k">Expenses (range)</div><div class="v" id="kpiExpenses">0.00</div></div>
            <div class="kpi"><div class="k">Profit (simple)</div><div class="v" id="kpiProfit">0.00</div></div>
            <div class="kpi"><div class="k">Invoices count</div><div class="v" id="kpiInvCount">0</div></div>
          </div>

          <div class="two">
            <div class="card">
              <div class="row">
                <div class="note">Dashboard range</div>
                <div class="sp"></div>
              </div>
              <div class="form" style="grid-template-columns:1fr 1fr 1fr">
                <div>
                  <div class="note">From</div>
                  <input class="input" id="dashFrom" type="date" />
                </div>
                <div>
                  <div class="note">To</div>
                  <input class="input" id="dashTo" type="date" />
                </div>
                <div>
                  <button class="btn primary" id="btnDashLoad">Load</button>
                </div>
              </div>
              <div class="note" id="dashMsg"></div>
            </div>

            <div class="card">
              <div class="note">Firestore status</div>
              <div style="font-weight:900;margin-top:6px" id="dbStatus">Not checked</div>
              <div class="note" style="margin-top:10px">Tip: keep rules open for the demo, then tighten later.</div>
            </div>
          </div>

          <div class="two" style="margin-top:12px">
            <div class="card">
              <div class="row"><div class="note">Latest invoices</div><div class="sp"></div></div>
              <table>
                <thead><tr><th>No</th><th>Date</th><th>Customer</th><th class="right">Total</th></tr></thead>
                <tbody id="dashInv"></tbody>
              </table>
            </div>
            <div class="card">
              <div class="row"><div class="note">Latest expenses</div><div class="sp"></div></div>
              <table>
                <thead><tr><th>Date</th><th>Category</th><th class="right">Amount</th></tr></thead>
                <tbody id="dashExp"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- CUSTOMERS -->
        <div id="view-customers" class="hidden">
          <h1 class="h1">Customers</h1>
          <div class="form">
            <div class="span2">
              <div class="note">Name</div>
              <input class="input" id="cName" placeholder="Customer name" />
            </div>
            <div>
              <div class="note">Phone</div>
              <input class="input" id="cPhone" placeholder="Phone" />
            </div>
            <div>
              <button class="btn primary" id="btnAddCustomer">Add</button>
            </div>
          </div>
          <div class="note" id="cMsg"></div>
          <hr />
          <table>
            <thead><tr><th>Name</th><th>Phone</th><th class="right">Actions</th></tr></thead>
            <tbody id="cTable"></tbody>
          </table>
        </div>

        <!-- SUPPLIERS -->
        <div id="view-suppliers" class="hidden">
          <h1 class="h1">Suppliers</h1>
          <div class="form">
            <div class="span2">
              <div class="note">Name</div>
              <input class="input" id="sName" placeholder="Supplier name" />
            </div>
            <div>
              <div class="note">Phone</div>
              <input class="input" id="sPhone" placeholder="Phone" />
            </div>
            <div>
              <button class="btn primary" id="btnAddSupplier">Add</button>
            </div>
          </div>
          <div class="note" id="sMsg"></div>
          <hr />
          <table>
            <thead><tr><th>Name</th><th>Phone</th><th class="right">Actions</th></tr></thead>
            <tbody id="sTable"></tbody>
          </table>
        </div>

        <!-- ITEMS -->
        <div id="view-items" class="hidden">
          <h1 class="h1">Items</h1>
          <div class="form">
            <div class="span2">
              <div class="note">Name</div>
              <input class="input" id="iName" placeholder="Item / Service name" />
            </div>
            <div>
              <div class="note">Sale price</div>
              <input class="input" id="iPrice" type="number" step="0.01" placeholder="0.00" />
            </div>
            <div>
              <button class="btn primary" id="btnAddItem">Add</button>
            </div>
            <div class="span2">
              <div class="note">Cost (optional)</div>
              <input class="input" id="iCost" type="number" step="0.01" placeholder="0.00" />
            </div>
            <div>
              <div class="note">Taxable</div>
              <select class="input" id="iTaxable">
                <option value="yes">Yes</option>
                <option value="no">No</option>
              </select>
            </div>
          </div>
          <div class="note" id="iMsg"></div>
          <hr />
          <table>
            <thead><tr><th>Name</th><th class="right">Price</th><th class="right">Cost</th><th>Taxable</th><th class="right">Actions</th></tr></thead>
            <tbody id="iTable"></tbody>
          </table>
        </div>

        <!-- EXPENSES -->
        <div id="view-expenses" class="hidden">
          <h1 class="h1">Expenses</h1>
          <div class="form">
            <div>
              <div class="note">Date</div>
              <input class="input" id="eDate" type="date" />
            </div>
            <div>
              <div class="note">Category</div>
              <input class="input" id="eCat" placeholder="e.g. Rent" />
            </div>
            <div>
              <div class="note">Amount</div>
              <input class="input" id="eAmt" type="number" step="0.01" placeholder="0.00" />
            </div>
            <div>
              <button class="btn primary" id="btnAddExpense">Add</button>
            </div>
            <div class="span4">
              <div class="note">Notes</div>
              <input class="input" id="eNotes" placeholder="Optional notes" />
            </div>
          </div>
          <div class="note" id="eMsg"></div>
          <hr />
          <table>
            <thead><tr><th>Date</th><th>Category</th><th>Notes</th><th class="right">Amount</th><th class="right">Actions</th></tr></thead>
            <tbody id="eTable"></tbody>
          </table>
        </div>

        <!-- INVOICES -->
        <div id="view-invoices" class="hidden">
          <h1 class="h1">Invoices</h1>

          <div class="linebox">
            <div class="form">
              <div>
                <div class="note">Date</div>
                <input class="input" id="invDate" type="date" />
              </div>
              <div class="span2">
                <div class="note">Customer</div>
                <select class="input" id="invCustomer"></select>
              </div>
              <div>
                <div class="note">Payment</div>
                <select class="input" id="invPay">
                  <option value="cash">Cash</option>
                  <option value="card">Card</option>
                  <option value="transfer">Transfer</option>
                </select>
              </div>

              <div class="span2">
                <div class="note">Item</div>
                <select class="input" id="lineItem"></select>
              </div>
              <div>
                <div class="note">Qty</div>
                <input class="input" id="lineQty" type="number" step="1" value="1" />
              </div>
              <div>
                <button class="btn" id="btnAddLine">Add line</button>
              </div>
            </div>

            <table>
              <thead><tr><th>Item</th><th class="right">Qty</th><th class="right">Price</th><th class="right">Line total</th><th class="right">Actions</th></tr></thead>
              <tbody id="linesTable"></tbody>
            </table>

            <div class="row" style="margin-top:12px">
              <div class="pill">Subtotal: <b id="invSub">0.00</b></div>
              <div class="pill">Tax: <b id="invTax">0.00</b></div>
              <div class="pill">Total: <b id="invTotal">0.00</b></div>
              <div class="sp"></div>
              <button class="btn primary" id="btnSaveInvoice">Save invoice</button>
            </div>

            <div class="note" id="invMsg" style="margin-top:10px"></div>
          </div>

          <hr />

          <div class="two">
            <div class="card">
              <div class="row">
                <div class="note">Saved invoices</div>
                <div class="sp"></div>
                <button class="btn small" id="btnReloadInvoices">Reload</button>
              </div>
              <table>
                <thead><tr><th>No</th><th>Date</th><th>Customer</th><th class="right">Total</th><th class="right">Actions</th></tr></thead>
                <tbody id="invTable"></tbody>
              </table>
            </div>

            <div class="card hidden" id="printBox">
              <div class="row no-print">
                <div class="note">Invoice preview</div>
                <div class="sp"></div>
                <button class="btn small" id="btnPrint">Print</button>
              </div>
              <div id="printArea"></div>
            </div>
          </div>
        </div>

        <!-- REPORTS -->
        <div id="view-reports" class="hidden">
          <h1 class="h1">Reports</h1>

          <div class="card">
            <div class="note">Date range</div>
            <div class="form" style="grid-template-columns:1fr 1fr 1fr">
              <div>
                <div class="note">From</div>
                <input class="input" id="rFrom" type="date" />
              </div>
              <div>
                <div class="note">To</div>
                <input class="input" id="rTo" type="date" />
              </div>
              <div>
                <button class="btn primary" id="btnRunReport">Run</button>
              </div>
            </div>

            <div class="cards" style="margin-top:10px">
              <div class="kpi"><div class="k">Sales</div><div class="v" id="rSales">0.00</div></div>
              <div class="kpi"><div class="k">Expenses</div><div class="v" id="rExpenses">0.00</div></div>
              <div class="kpi"><div class="k">Tax collected</div><div class="v" id="rTax">0.00</div></div>
              <div class="kpi"><div class="k">Profit (simple)</div><div class="v" id="rProfit">0.00</div></div>
            </div>

            <div class="two" style="margin-top:12px">
              <div class="card">
                <div class="note">Invoices in range</div>
                <table>
                  <thead><tr><th>No</th><th>Date</th><th>Customer</th><th class="right">Total</th></tr></thead>
                  <tbody id="rInvTable"></tbody>
                </table>
              </div>
              <div class="card">
                <div class="note">Expenses in range</div>
                <table>
                  <thead><tr><th>Date</th><th>Category</th><th class="right">Amount</th></tr></thead>
                  <tbody id="rExpTable"></tbody>
                </table>
              </div>
            </div>

            <div class="note" id="rMsg" style="margin-top:10px"></div>
          </div>
        </div>

        <!-- SETTINGS -->
        <div id="view-settings" class="hidden">
          <h1 class="h1">Settings</h1>

          <div class="card">
            <div class="form">
              <div class="span2">
                <div class="note">Company name</div>
                <input class="input" id="setCompany" placeholder="Company name" />
              </div>
              <div>
                <div class="note">Currency</div>
                <input class="input" id="setCurrency" placeholder="e.g. SAR" />
              </div>
              <div>
                <div class="note">Tax rate (%)</div>
                <input class="input" id="setTax" type="number" step="0.01" placeholder="15" />
              </div>
              <div class="span4">
                <button class="btn primary" id="btnSaveSettings">Save settings</button>
                <span class="note" id="setMsg" style="margin-left:10px"></span>
              </div>
            </div>
            <div class="note">Tax is applied only to invoice lines where item.taxable = Yes</div>
          </div>
        </div>

      </main>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
    import {
      getFirestore,
      collection, doc, getDoc, getDocs, setDoc, addDoc, deleteDoc, updateDoc,
      serverTimestamp,
      query, where, orderBy, limit,
      runTransaction
    } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDmaEu0Oyg7vHpmEaNbfv5nhqvfhcpN7_g",
      authDomain: "maher-7598f.firebaseapp.com",
      projectId: "maher-7598f",
      storageBucket: "maher-7598f.firebasestorage.app",
      messagingSenderId: "649677161587",
      appId: "1:649677161587:web:e95932abdea8835e951606"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const $ = (id)=>document.getElementById(id);

    const loginView = $("loginView");
    const appView = $("appView");

    const userPill = $("userPill");
    const btnLogout = $("btnLogout");
    const loginMsg = $("loginMsg");

    const companyPill = $("companyPill");
    const dbStatus = $("dbStatus");
    const dbBadge = $("dbBadge");

    const views = {
      dashboard: $("view-dashboard"),
      customers: $("view-customers"),
      suppliers: $("view-suppliers"),
      items: $("view-items"),
      expenses: $("view-expenses"),
      invoices: $("view-invoices"),
      reports: $("view-reports"),
      settings: $("view-settings"),
    };

    const state = {
      settings: { company:"-", currency:"SAR", taxRate:0 },
      customers: [],
      suppliers: [],
      items: [],
      invoiceLines: [],
      lastPrinted: null
    };

    function todayISO(){
      const d = new Date();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      return `${d.getFullYear()}-${m}-${day}`;
    }

    function n(v){ const x = Number(v); return Number.isFinite(x) ? x : 0; }
    function money(x){
      const cur = state.settings.currency || "";
      return `${n(x).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})} ${cur}`.trim();
    }
    function esc(s){
      return String(s||"")
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }

    function show(key){
      Object.values(views).forEach(v=>v.classList.add("hidden"));
      views[key].classList.remove("hidden");

      document.querySelectorAll("[data-nav]").forEach(a=>{
        a.classList.toggle("active", a.dataset.nav === key);
      });

      if(key==="customers") loadCustomers();
      if(key==="suppliers") loadSuppliers();
      if(key==="items") loadItems();
      if(key==="expenses") loadExpenses();
      if(key==="invoices") prepareInvoices();
      if(key==="reports") initReportsDates();
      if(key==="settings") fillSettingsForm();
      if(key==="dashboard") loadDashboard();
    }

    document.querySelectorAll("[data-nav]").forEach(a=>{
      a.addEventListener("click",(e)=>{
        e.preventDefault();
        show(a.dataset.nav);
      });
    });

    $("btnLogin").onclick = async ()=>{
      const email = $("email").value.trim();
      const password = $("password").value;
      loginMsg.textContent = "Signing in...";
      try{
        await signInWithEmailAndPassword(auth, email, password);
        loginMsg.textContent = "OK";
      }catch(e){
        loginMsg.textContent = e?.message || "Login failed";
      }
    };

    btnLogout.onclick = async ()=>{ await signOut(auth); };

    async function pingFirestore(uid, email){
      try{
        await setDoc(doc(db, "ping", uid), { email: email || null, at: serverTimestamp() }, { merge:true });
        dbStatus.textContent = "OK (write success)";
        dbBadge.textContent = "OK";
        dbBadge.style.borderColor = "rgba(45,212,191,.7)";
      }catch(e){
        dbStatus.textContent = "Blocked (check rules)";
        dbBadge.textContent = "NO";
        dbBadge.style.borderColor = "rgba(255,79,109,.7)";
      }
    }

    async function getSettings(){
      const ref = doc(db, "settings", "main");
      const snap = await getDoc(ref);
      if(snap.exists()){
        const d = snap.data();
        state.settings.company = d.company || "-";
        state.settings.currency = d.currency || "SAR";
        state.settings.taxRate = n(d.taxRate);
      }else{
        await setDoc(ref, { company:"-", currency:"SAR", taxRate:0, updatedAt: serverTimestamp() }, { merge:true });
        state.settings = { company:"-", currency:"SAR", taxRate:0 };
      }
      companyPill.textContent = `Company: ${state.settings.company}`;
    }

    async function preloadLists(){
      await Promise.all([ loadCustomers(true), loadSuppliers(true), loadItems(true) ]);
    }

    // Customers
    $("btnAddCustomer").onclick = async ()=>{
      const name = $("cName").value.trim();
      const phone = $("cPhone").value.trim();
      $("cMsg").textContent = "";
      if(!name){ $("cMsg").textContent = "Name is required"; return; }
      await addDoc(collection(db,"customers"), { name, phone, createdAt: serverTimestamp() });
      $("cName").value=""; $("cPhone").value="";
      $("cMsg").textContent = "Saved";
      await loadCustomers();
      await preloadLists();
    };

    async function loadCustomers(silent=false){
      const tbody = $("cTable");
      if(!silent) tbody.innerHTML = `<tr><td colspan="3" class="note">Loading...</td></tr>`;
      const snap = await getDocs(collection(db,"customers"));
      const rows = [];
      snap.forEach(d=>rows.push({ id:d.id, ...d.data() }));
      rows.sort((a,b)=>String(a.name||"").localeCompare(String(b.name||"")));
      state.customers = rows;

      if(silent) return;

      tbody.innerHTML = "";
      if(rows.length===0){
        tbody.innerHTML = `<tr><td colspan="3" class="note">No customers yet</td></tr>`;
        return;
      }

      for(const r of rows){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${esc(r.name)}</td>
          <td>${esc(r.phone||"")}</td>
          <td class="right">
            <button class="btn danger small" data-del="${r.id}">Delete</button>
          </td>`;
        tr.querySelector("[data-del]").onclick = async ()=>{
          await deleteDoc(doc(db,"customers", r.id));
          await loadCustomers();
          await preloadLists();
        };
        tbody.appendChild(tr);
      }
    }

    // Suppliers
    $("btnAddSupplier").onclick = async ()=>{
      const name = $("sName").value.trim();
      const phone = $("sPhone").value.trim();
      $("sMsg").textContent = "";
      if(!name){ $("sMsg").textContent = "Name is required"; return; }
      await addDoc(collection(db,"suppliers"), { name, phone, createdAt: serverTimestamp() });
      $("sName").value=""; $("sPhone").value="";
      $("sMsg").textContent = "Saved";
      await loadSuppliers();
      await preloadLists();
    };

    async function loadSuppliers(silent=false){
      const tbody = $("sTable");
      if(!silent) tbody.innerHTML = `<tr><td colspan="3" class="note">Loading...</td></tr>`;
      const snap = await getDocs(collection(db,"suppliers"));
      const rows = [];
      snap.forEach(d=>rows.push({ id:d.id, ...d.data() }));
      rows.sort((a,b)=>String(a.name||"").localeCompare(String(b.name||"")));
      state.suppliers = rows;

      if(silent) return;

      tbody.innerHTML = "";
      if(rows.length===0){
        tbody.innerHTML = `<tr><td colspan="3" class="note">No suppliers yet</td></tr>`;
        return;
      }

      for(const r of rows){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${esc(r.name)}</td>
          <td>${esc(r.phone||"")}</td>
          <td class="right">
            <button class="btn danger small" data-del="${r.id}">Delete</button>
          </td>`;
        tr.querySelector("[data-del]").onclick = async ()=>{
          await deleteDoc(doc(db,"suppliers", r.id));
          await loadSuppliers();
          await preloadLists();
        };
        tbody.appendChild(tr);
      }
    }

    // Items
    $("btnAddItem").onclick = async ()=>{
      const name = $("iName").value.trim();
      const price = n($("iPrice").value);
      const cost = n($("iCost").value);
      const taxable = $("iTaxable").value === "yes";
      $("iMsg").textContent = "";
      if(!name){ $("iMsg").textContent = "Name is required"; return; }
      await addDoc(collection(db,"items"), { name, price, cost, taxable, createdAt: serverTimestamp() });
      $("iName").value=""; $("iPrice").value=""; $("iCost").value="";
      $("iMsg").textContent = "Saved";
      await loadItems();
      await preloadLists();
    };

    async function loadItems(silent=false){
      const tbody = $("iTable");
      if(!silent) tbody.innerHTML = `<tr><td colspan="5" class="note">Loading...</td></tr>`;
      const snap = await getDocs(collection(db,"items"));
      const rows = [];
      snap.forEach(d=>rows.push({ id:d.id, ...d.data() }));
      rows.sort((a,b)=>String(a.name||"").localeCompare(String(b.name||"")));
      state.items = rows;

      if(silent) return;

      tbody.innerHTML = "";
      if(rows.length===0){
        tbody.innerHTML = `<tr><td colspan="5" class="note">No items yet</td></tr>`;
        return;
      }

      for(const r of rows){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${esc(r.name)}</td>
          <td class="right">${money(r.price)}</td>
          <td class="right">${money(r.cost)}</td>
          <td>${r.taxable ? "Yes" : "No"}</td>
          <td class="right">
            <button class="btn danger small" data-del="${r.id}">Delete</button>
          </td>`;
        tr.querySelector("[data-del]").onclick = async ()=>{
          await deleteDoc(doc(db,"items", r.id));
          await loadItems();
          await preloadLists();
        };
        tbody.appendChild(tr);
      }
    }

    // Expenses
    $("btnAddExpense").onclick = async ()=>{
      const date = $("eDate").value || todayISO();
      const category = $("eCat").value.trim();
      const amount = n($("eAmt").value);
      const notes = $("eNotes").value.trim();
      $("eMsg").textContent = "";
      if(!category){ $("eMsg").textContent = "Category is required"; return; }
      if(amount<=0){ $("eMsg").textContent = "Amount must be > 0"; return; }
      await addDoc(collection(db,"expenses"), { date, category, amount, notes, createdAt: serverTimestamp() });
      $("eCat").value=""; $("eAmt").value=""; $("eNotes").value="";
      $("eMsg").textContent = "Saved";
      await loadExpenses();
    };

    async function loadExpenses(){
      const tbody = $("eTable");
      tbody.innerHTML = `<tr><td colspan="5" class="note">Loading...</td></tr>`;
      const qx = query(collection(db,"expenses"), orderBy("date","desc"), limit(200));
      const snap = await getDocs(qx);
      const rows = [];
      snap.forEach(d=>rows.push({ id:d.id, ...d.data() }));
      tbody.innerHTML = "";
      if(rows.length===0){
        tbody.innerHTML = `<tr><td colspan="5" class="note">No expenses yet</td></tr>`;
        return;
      }
      for(const r of rows){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${esc(r.date||"")}</td>
          <td>${esc(r.category||"")}</td>
          <td>${esc(r.notes||"")}</td>
          <td class="right">${money(r.amount)}</td>
          <td class="right"><button class="btn danger small" data-del="${r.id}">Delete</button></td>`;
        tr.querySelector("[data-del]").onclick = async ()=>{
          await deleteDoc(doc(db,"expenses", r.id));
          await loadExpenses();
        };
        tbody.appendChild(tr);
      }
    }

    // Invoices
    function fillInvoiceSelects(){
      const cust = $("invCustomer");
      const item = $("lineItem");
      cust.innerHTML = "";
      item.innerHTML = "";

      if(state.customers.length===0){
        cust.innerHTML = `<option value="">No customers</option>`;
      }else{
        cust.innerHTML = `<option value="">Select customer</option>` + state.customers.map(c=>`<option value="${c.id}">${esc(c.name)}</option>`).join("");
      }

      if(state.items.length===0){
        item.innerHTML = `<option value="">No items</option>`;
      }else{
        item.innerHTML = `<option value="">Select item</option>` + state.items.map(i=>`<option value="${i.id}">${esc(i.name)}</option>`).join("");
      }
    }

    function calcInvoiceTotals(){
      let sub = 0;
      let tax = 0;
      const rate = n(state.settings.taxRate) / 100;

      for(const l of state.invoiceLines){
        const lineTotal = n(l.qty) * n(l.price);
        sub += lineTotal;
        if(l.taxable) tax += lineTotal * rate;
      }

      const total = sub + tax;
      $("invSub").textContent = money(sub);
      $("invTax").textContent = money(tax);
      $("invTotal").textContent = money(total);

      return { sub, tax, total };
    }

    function renderLines(){
      const tbody = $("linesTable");
      tbody.innerHTML = "";
      if(state.invoiceLines.length===0){
        tbody.innerHTML = `<tr><td colspan="5" class="note">No lines yet</td></tr>`;
        calcInvoiceTotals();
        return;
      }

      state.invoiceLines.forEach((l, idx)=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${esc(l.name)}</td>
          <td class="right">${esc(l.qty)}</td>
          <td class="right">${money(l.price)}</td>
          <td class="right">${money(n(l.qty)*n(l.price))}</td>
          <td class="right"><button class="btn danger small" data-rm="${idx}">Remove</button></td>
        `;
        tr.querySelector("[data-rm]").onclick = ()=>{
          state.invoiceLines.splice(idx,1);
          renderLines();
        };
        tbody.appendChild(tr);
      });

      calcInvoiceTotals();
    }

    $("btnAddLine").onclick = ()=>{
      const itemId = $("lineItem").value;
      const qty = Math.max(1, Math.floor(n($("lineQty").value || 1)));
      $("invMsg").textContent = "";

      const it = state.items.find(x=>x.id===itemId);
      if(!it){ $("invMsg").textContent = "Select an item"; return; }

      state.invoiceLines.push({
        itemId: it.id,
        name: it.name,
        qty,
        price: n(it.price),
        cost: n(it.cost),
        taxable: !!it.taxable
      });

      renderLines();
    };

    async function getNextInvoiceNumber(){
      const ref = doc(db, "counters", "invoices");
      const next = await runTransaction(db, async (tx)=>{
        const snap = await tx.get(ref);
        let cur = 1;
        if(snap.exists()){
          cur = n(snap.data().next);
          if(cur <= 0) cur = 1;
        }
        tx.set(ref, { next: cur + 1, updatedAt: serverTimestamp() }, { merge:true });
        return cur;
      });
      return next;
    }

    $("btnSaveInvoice").onclick = async ()=>{
      const date = $("invDate").value || todayISO();
      const custId = $("invCustomer").value;
      const pay = $("invPay").value;
      $("invMsg").textContent = "";

      const cust = state.customers.find(x=>x.id===custId);
      if(!cust){ $("invMsg").textContent = "Select a customer"; return; }
      if(state.invoiceLines.length===0){ $("invMsg").textContent = "Add at least one line"; return; }

      const totals = calcInvoiceTotals();
      const number = await getNextInvoiceNumber();

      const data = {
        number,
        date,
        customerId: cust.id,
        customerName: cust.name,
        paymentMethod: pay,
        subtotal: totals.sub,
        tax: totals.tax,
        total: totals.total,
        lines: state.invoiceLines.map(l=>({
          itemId: l.itemId,
          name: l.name,
          qty: n(l.qty),
          price: n(l.price),
          taxable: !!l.taxable
        })),
        createdAt: serverTimestamp()
      };

      try{
        const ref = await addDoc(collection(db,"invoices"), data);
        $("invMsg").textContent = `Saved invoice #${number}`;
        state.invoiceLines = [];
        renderLines();
        await loadInvoices();
        await showInvoiceForPrint({ id: ref.id, ...data });
      }catch(e){
        $("invMsg").textContent = e?.message || "Save failed";
      }
    };

    $("btnReloadInvoices").onclick = ()=> loadInvoices();

    async function loadInvoices(){
      const tbody = $("invTable");
      tbody.innerHTML = `<tr><td colspan="5" class="note">Loading...</td></tr>`;
      const qx = query(collection(db,"invoices"), orderBy("date","desc"), limit(200));
      const snap = await getDocs(qx);
      const rows = [];
      snap.forEach(d=>rows.push({ id:d.id, ...d.data() }));

      tbody.innerHTML = "";
      if(rows.length===0){
        tbody.innerHTML = `<tr><td colspan="5" class="note">No invoices yet</td></tr>`;
        return;
      }

      for(const r of rows){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${esc(r.number)}</td>
          <td>${esc(r.date||"")}</td>
          <td>${esc(r.customerName||"")}</td>
          <td class="right">${money(r.total)}</td>
          <td class="right">
            <button class="btn small" data-view="${r.id}">View</button>
            <button class="btn danger small" data-del="${r.id}">Delete</button>
          </td>
        `;
        tr.querySelector("[data-view]").onclick = async ()=>{
          await showInvoiceForPrint(r);
        };
        tr.querySelector("[data-del]").onclick = async ()=>{
          await deleteDoc(doc(db,"invoices", r.id));
          $("printBox").classList.add("hidden");
          await loadInvoices();
        };
        tbody.appendChild(tr);
      }
    }

    async function showInvoiceForPrint(inv){
      $("printBox").classList.remove("hidden");
      state.lastPrinted = inv;
      const lines = inv.lines || [];
      const company = state.settings.company || "-";
      const cur = state.settings.currency || "";

      const rows = lines.map(l=>`
        <tr>
          <td>${esc(l.name)}</td>
          <td class="right">${esc(l.qty)}</td>
          <td class="right">${money(l.price)}</td>
          <td class="right">${money(n(l.qty)*n(l.price))}</td>
        </tr>
      `).join("");

      $("printArea").innerHTML = `
        <div class="card" style="border-radius:14px">
          <div class="row">
            <div>
              <div style="font-weight:900;font-size:18px">${esc(company)}</div>
              <div class="note">Invoice</div>
            </div>
            <div class="sp"></div>
            <div class="right">
              <div class="pill">No: <b>${esc(inv.number)}</b></div>
              <div class="pill" style="margin-top:6px">Date: <b>${esc(inv.date||"")}</b></div>
            </div>
          </div>

          <hr />

          <div class="row">
            <div><span class="note">Customer:</span> <b>${esc(inv.customerName||"")}</b></div>
            <div class="sp"></div>
            <div><span class="note">Payment:</span> <b>${esc(inv.paymentMethod||"")}</b></div>
          </div>

          <hr />

          <table>
            <thead><tr><th>Item</th><th class="right">Qty</th><th class="right">Price (${esc(cur)})</th><th class="right">Total</th></tr></thead>
            <tbody>${rows}</tbody>
          </table>

          <hr />

          <div class="row">
            <div class="sp"></div>
            <div class="right" style="min-width:260px">
              <div class="row"><div class="sp note">Subtotal</div><div><b>${money(inv.subtotal)}</b></div></div>
              <div class="row"><div class="sp note">Tax</div><div><b>${money(inv.tax)}</b></div></div>
              <div class="row"><div class="sp note">Total</div><div style="font-size:18px;font-weight:900">${money(inv.total)}</div></div>
            </div>
          </div>
        </div>
      `;
    }

    $("btnPrint").onclick = ()=> window.print();

    function prepareInvoices(){
      $("invDate").value = $("invDate").value || todayISO();
      $("lineQty").value = $("lineQty").value || 1;
      fillInvoiceSelects();
      renderLines();
      loadInvoices();
    }

    // Reports
    function initReportsDates(){
      const to = todayISO();
      const d = new Date();
      d.setDate(d.getDate() - 30);
      const from = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
      $("rFrom").value = $("rFrom").value || from;
      $("rTo").value = $("rTo").value || to;
    }

    $("btnRunReport").onclick = async ()=>{
      const from = $("rFrom").value;
      const to = $("rTo").value;
      $("rMsg").textContent = "";
      if(!from || !to){ $("rMsg").textContent = "Select from/to"; return; }

      const invQ = query(
        collection(db,"invoices"),
        where("date", ">=", from),
        where("date", "<=", to),
        orderBy("date","desc"),
        limit(500)
      );

      const expQ = query(
        collection(db,"expenses"),
        where("date", ">=", from),
        where("date", "<=", to),
        orderBy("date","desc"),
        limit(500)
      );

      const [invSnap, expSnap] = await Promise.all([ getDocs(invQ), getDocs(expQ) ]);

      const invoices = [];
      invSnap.forEach(d=>invoices.push({ id:d.id, ...d.data() }));

      const expenses = [];
      expSnap.forEach(d=>expenses.push({ id:d.id, ...d.data() }));

      const sales = invoices.reduce((a,x)=>a+n(x.total),0);
      const tax = invoices.reduce((a,x)=>a+n(x.tax),0);
      const exp = expenses.reduce((a,x)=>a+n(x.amount),0);
      const profit = sales - exp;

      $("rSales").textContent = money(sales);
      $("rExpenses").textContent = money(exp);
      $("rTax").textContent = money(tax);
      $("rProfit").textContent = money(profit);

      $("rInvTable").innerHTML = invoices.length
        ? invoices.map(x=>`<tr><td>${esc(x.number)}</td><td>${esc(x.date||"")}</td><td>${esc(x.customerName||"")}</td><td class="right">${money(x.total)}</td></tr>`).join("")
        : `<tr><td colspan="4" class="note">No invoices in range</td></tr>`;

      $("rExpTable").innerHTML = expenses.length
        ? expenses.map(x=>`<tr><td>${esc(x.date||"")}</td><td>${esc(x.category||"")}</td><td class="right">${money(x.amount)}</td></tr>`).join("")
        : `<tr><td colspan="3" class="note">No expenses in range</td></tr>`;

      $("rMsg").textContent = `Invoices: ${invoices.length} | Expenses: ${expenses.length}`;
    };

    // Settings
    function fillSettingsForm(){
      $("setCompany").value = state.settings.company || "-";
      $("setCurrency").value = state.settings.currency || "SAR";
      $("setTax").value = n(state.settings.taxRate);
      $("setMsg").textContent = "";
    }

    $("btnSaveSettings").onclick = async ()=>{
      const company = $("setCompany").value.trim() || "-";
      const currency = $("setCurrency").value.trim() || "SAR";
      const taxRate = n($("setTax").value);
      await setDoc(doc(db,"settings","main"), { company, currency, taxRate, updatedAt: serverTimestamp() }, { merge:true });
      await getSettings();
      $("setMsg").textContent = "Saved";
    };

    // Dashboard
    $("btnDashLoad").onclick = ()=> loadDashboard();

    async function loadDashboard(){
      const msg = $("dashMsg");
      const from = $("dashFrom").value || (()=>{ const d=new Date(); d.setDate(d.getDate()-30); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`; })();
      const to = $("dashTo").value || todayISO();
      $("dashFrom").value = from;
      $("dashTo").value = to;

      msg.textContent = "Loading...";

      const invQ = query(
        collection(db,"invoices"),
        where("date", ">=", from),
        where("date", "<=", to),
        orderBy("date","desc"),
        limit(10)
      );

      const expQ = query(
        collection(db,"expenses"),
        where("date", ">=", from),
        where("date", "<=", to),
        orderBy("date","desc"),
        limit(10)
      );

      const [invSnap, expSnap] = await Promise.all([ getDocs(invQ), getDocs(expQ) ]);

      const inv = [];
      invSnap.forEach(d=>inv.push({ id:d.id, ...d.data() }));
      const exp = [];
      expSnap.forEach(d=>exp.push({ id:d.id, ...d.data() }));

      const sales = inv.reduce((a,x)=>a+n(x.total),0);
      const expenses = exp.reduce((a,x)=>a+n(x.amount),0);
      const profit = sales - expenses;

      $("kpiSales").textContent = money(sales);
      $("kpiExpenses").textContent = money(expenses);
      $("kpiProfit").textContent = money(profit);
      $("kpiInvCount").textContent = String(inv.length);

      $("dashInv").innerHTML = inv.length
        ? inv.map(x=>`<tr><td>${esc(x.number)}</td><td>${esc(x.date||"")}</td><td>${esc(x.customerName||"")}</td><td class="right">${money(x.total)}</td></tr>`).join("")
        : `<tr><td colspan="4" class="note">No invoices</td></tr>`;

      $("dashExp").innerHTML = exp.length
        ? exp.map(x=>`<tr><td>${esc(x.date||"")}</td><td>${esc(x.category||"")}</td><td class="right">${money(x.amount)}</td></tr>`).join("")
        : `<tr><td colspan="3" class="note">No expenses</td></tr>`;

      msg.textContent = `Range: ${from} to ${to}`;
    }

    // Auth bootstrap
    onAuthStateChanged(auth, async (user)=>{
      if(!user){
        userPill.textContent = "Not signed in";
        btnLogout.classList.add("hidden");
        loginView.classList.remove("hidden");
        appView.classList.add("hidden");
        return;
      }

      userPill.textContent = user.email || "Signed in";
      btnLogout.classList.remove("hidden");
      loginView.classList.add("hidden");
      appView.classList.remove("hidden");

      $("eDate").value = $("eDate").value || todayISO();
      $("invDate").value = $("invDate").value || todayISO();

      await pingFirestore(user.uid, user.email);
      await getSettings();
      await preloadLists();
      await loadDashboard();

      show("dashboard");
    });
  </script>
</body>
</html>
